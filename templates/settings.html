{% extends "base.html" %}
{% block title %}Settings - 3DP Deal Tracker{% endblock %}

{% block content %}
<h4 class="mb-3">Settings</h4>

<!-- Scheduler Controls -->
<div class="card mb-4">
    <div class="card-body d-flex align-items-center justify-content-between">
        <div>
            <strong>Scheduler:</strong>
            <span id="sched-status" class="badge {% if scheduler.running %}bg-success{% else %}bg-secondary{% endif %}">
                {{ "Running" if scheduler.running else "Stopped" }}
            </span>
            {% if scheduler.running and scheduler.next_run %}
            <span class="text-muted ms-2">Next: {{ scheduler.next_run[:19] }}</span>
            {% endif %}
            <span id="sched-scraping" class="badge bg-warning ms-2" style="display:{% if scheduler.scraping %}inline{% else %}none{% endif %}">
                Scraping...
            </span>
        </div>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-sm btn-success" onclick="schedulerAction('start')" id="btn-start"
                    {% if scheduler.running %}disabled{% endif %}>Start</button>
            <button type="button" class="btn btn-sm btn-danger" onclick="schedulerAction('stop')" id="btn-stop"
                    {% if not scheduler.running %}disabled{% endif %}>Stop</button>
            <button type="button" class="btn btn-sm btn-primary" onclick="schedulerAction('trigger')">Scrape Now</button>
        </div>
    </div>
</div>

<!-- Tabs -->
<ul class="nav nav-tabs" role="tablist">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-general">General</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-queries">Search Queries</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-brands">Brands</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-msrp">MSRP Data</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-data">Data Management</a></li>
</ul>

<div class="tab-content pt-3">
    <!-- General Settings -->
    <div class="tab-pane active" id="tab-general">
        <form id="settings-form" class="row g-3" style="max-width: 500px;">
            <div class="col-12">
                <label class="form-label">Scrape interval (hours)</label>
                <input type="number" step="0.5" min="0.5" class="form-control" name="scrape_interval_hours"
                       value="{{ settings.scrape_interval_hours | default(6) }}">
            </div>
            <div class="col-12">
                <label class="form-label">Max pages per query</label>
                <input type="number" min="1" max="50" class="form-control" name="max_pages_per_query"
                       value="{{ settings.max_pages_per_query | default(5) }}">
            </div>
            <div class="col-6">
                <label class="form-label">Request delay min (sec)</label>
                <input type="number" step="0.5" min="0.5" class="form-control" name="request_delay_min"
                       value="{{ settings.request_delay_min | default(2) }}">
            </div>
            <div class="col-6">
                <label class="form-label">Request delay max (sec)</label>
                <input type="number" step="0.5" min="1" class="form-control" name="request_delay_max"
                       value="{{ settings.request_delay_max | default(5) }}">
            </div>
            <div class="col-12">
                <label class="form-label">Inactive threshold (missed runs)</label>
                <input type="number" min="1" max="20" class="form-control" name="inactive_threshold"
                       value="{{ settings.inactive_threshold | default(3) }}">
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-primary">Save Settings</button>
                <span id="settings-saved" class="text-success ms-2" style="display:none">Saved!</span>
            </div>
            <div class="col-12 mt-4">
                <div class="card border-danger">
                    <div class="card-body">
                        <h6 class="text-danger mb-2">Danger Zone</h6>
                        <p class="small text-muted mb-3">
                            Clear scraped listing data (listings, price snapshots, and scrape run history).
                            Search queries and settings are preserved.
                        </p>
                        <button type="button" class="btn btn-danger btn-sm" onclick="clearDatabase()">
                            Clear DB
                        </button>
                    </div>
                </div>
            </div>
        </form>

        <hr class="my-4" style="max-width: 700px;">

        <form id="webhook-form" class="row g-3" style="max-width: 700px;">
            <div class="col-12">
                <h6 class="mb-2">Webhook Notifications</h6>
                <div class="form-check">
                    <input id="webhook-enabled" class="form-check-input" type="checkbox" {% if settings.webhook_enabled %}checked{% endif %}>
                    <label class="form-check-label" for="webhook-enabled">Enable webhook notifications</label>
                </div>
            </div>
            <div class="col-md-8">
                <label class="form-label">Webhook URL</label>
                <input id="webhook-url" type="url" class="form-control"
                       value="{{ settings.webhook_url | default('') }}"
                       placeholder="https://...">
            </div>
            <div class="col-md-4">
                <label class="form-label">Provider</label>
                <select id="webhook-provider" class="form-select">
                    {% set provider = settings.webhook_provider | default('generic') %}
                    <option value="generic" {% if provider == 'generic' %}selected{% endif %}>generic</option>
                    <option value="discord" {% if provider == 'discord' %}selected{% endif %}>discord</option>
                    <option value="google_chat" {% if provider == 'google_chat' %}selected{% endif %}>google_chat</option>
                </select>
            </div>
            {% set selected_events = settings.webhook_events | default(['scrape_completed', 'new_deal_detected', 'scrape_failed']) %}
            <div class="col-12">
                <label class="form-label mb-1">Events</label>
                <div class="d-flex flex-wrap gap-3">
                    <div class="form-check">
                        <input id="evt-scrape-completed" class="form-check-input webhook-event" type="checkbox"
                               value="scrape_completed" {% if 'scrape_completed' in selected_events %}checked{% endif %}>
                        <label class="form-check-label" for="evt-scrape-completed">scrape_completed</label>
                    </div>
                    <div class="form-check">
                        <input id="evt-new-deal" class="form-check-input webhook-event" type="checkbox"
                               value="new_deal_detected" {% if 'new_deal_detected' in selected_events %}checked{% endif %}>
                        <label class="form-check-label" for="evt-new-deal">new_deal_detected</label>
                    </div>
                    <div class="form-check">
                        <input id="evt-scrape-failed" class="form-check-input webhook-event" type="checkbox"
                               value="scrape_failed" {% if 'scrape_failed' in selected_events %}checked{% endif %}>
                        <label class="form-check-label" for="evt-scrape-failed">scrape_failed</label>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <label class="form-label">Deal max ratio</label>
                <input id="webhook-deal-ratio" type="number" step="0.01" min="0.1" max="2.0" class="form-control"
                       value="{{ settings.webhook_deal_max_price_to_retail_ratio | default(0.9) }}">
                <div class="form-text">price_to_retail_ratio threshold</div>
            </div>
            <div class="col-md-4">
                <label class="form-label">Deal min drop %</label>
                <input id="webhook-deal-drop" type="number" step="0.1" min="0" max="100" class="form-control"
                       value="{{ settings.webhook_deal_min_drop_pct | default(15) }}">
            </div>
            <div class="col-md-4">
                <label class="form-label">Deal batch size</label>
                <input id="webhook-deal-batch" type="number" min="1" max="20" class="form-control"
                       value="{{ settings.webhook_deal_batch_size | default(5) }}">
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-primary">Save Webhook Settings</button>
                <button type="button" id="webhook-test-btn" class="btn btn-outline-secondary ms-2">Send Test</button>
                <span id="webhook-saved" class="text-success ms-2" style="display:none">Saved!</span>
            </div>
        </form>
    </div>

    <!-- Search Queries -->
    <div class="tab-pane" id="tab-queries">
        <table class="table table-sm" id="queries-table">
            <thead>
                <tr><th>Label</th><th>URL</th><th>Enabled</th><th>Actions</th></tr>
            </thead>
            <tbody>
                {% for q in queries %}
                <tr data-id="{{ q.id }}">
                    <td>{{ q.label }}</td>
                    <td class="text-truncate" style="max-width:400px">{{ q.url }}</td>
                    <td>
                        <input type="checkbox" class="form-check-input query-toggle"
                               data-id="{{ q.id }}" {% if q.enabled %}checked{% endif %}>
                    </td>
                    <td>
                        <div class="d-flex gap-1">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="scrapeQuery({{ q.id }}, this)">Scrape</button>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteQuery({{ q.id }}, this)">Delete</button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <form id="add-query-form" class="row g-2 align-items-end" style="max-width: 700px;">
            <div class="col-3">
                <label class="form-label">Label</label>
                <input type="text" class="form-control form-control-sm" name="label" placeholder="e.g. bambu lab" required>
            </div>
            <div class="col-7">
                <label class="form-label">URL</label>
                <input type="url" class="form-control form-control-sm" name="url"
                       placeholder="https://www.kijiji.ca/b-canada/bambu-lab/k0l0" required>
            </div>
            <div class="col-2">
                <button type="submit" class="btn btn-sm btn-primary w-100">Add</button>
            </div>
        </form>
    </div>

    <!-- Brands -->
    <div class="tab-pane" id="tab-brands">
        <table class="table table-sm" id="brands-table">
            <thead>
                <tr><th>Brand</th><th>Keyword</th><th></th></tr>
            </thead>
            <tbody>
                {% for b in brands %}
                <tr data-id="{{ b.id }}">
                    <td>{{ b.brand }}</td>
                    <td>{{ b.keyword }}</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteBrand({{ b.id }}, this)">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <form id="add-brand-form" class="row g-2 align-items-end" style="max-width: 500px;">
            <div class="col-4">
                <label class="form-label">Brand</label>
                <input type="text" class="form-control form-control-sm" name="brand" placeholder="e.g. bambu" required>
            </div>
            <div class="col-5">
                <label class="form-label">Keyword</label>
                <input type="text" class="form-control form-control-sm" name="keyword" placeholder="e.g. a1 combo" required>
            </div>
            <div class="col-3">
                <button type="submit" class="btn btn-sm btn-primary w-100">Add</button>
            </div>
        </form>
    </div>

    <!-- MSRP Data -->
    <div class="tab-pane" id="tab-msrp">
        <table class="table table-sm" id="msrp-table">
            <thead>
                <tr><th>Brand</th><th>Model</th><th>MSRP (CAD)</th><th>MSRP (USD)</th><th></th></tr>
            </thead>
            <tbody>
                {% for m in msrp %}
                <tr data-id="{{ m.id }}">
                    <td>{{ m.brand }}</td>
                    <td>{{ m.model }}</td>
                    <td>${{ "%.0f"|format(m.msrp_cad) }}</td>
                    <td>{% if m.msrp_usd %}${{ "%.0f"|format(m.msrp_usd) }}{% else %}-{% endif %}</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteMsrp({{ m.id }}, this)">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <form id="add-msrp-form" class="row g-2 align-items-end" style="max-width: 700px;">
            <div class="col-3">
                <label class="form-label">Brand</label>
                <input type="text" class="form-control form-control-sm" name="brand" placeholder="bambu" required>
            </div>
            <div class="col-3">
                <label class="form-label">Model</label>
                <input type="text" class="form-control form-control-sm" name="model" placeholder="A1 Mini" required>
            </div>
            <div class="col-2">
                <label class="form-label">CAD $</label>
                <input type="number" class="form-control form-control-sm" name="msrp_cad" required>
            </div>
            <div class="col-2">
                <label class="form-label">USD $</label>
                <input type="number" class="form-control form-control-sm" name="msrp_usd">
            </div>
            <div class="col-2">
                <button type="submit" class="btn btn-sm btn-primary w-100">Add</button>
            </div>
        </form>
    </div>
    <!-- Data Management -->
    <div class="tab-pane" id="tab-data">
        <div class="row g-4">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Export Data</h5>
                        <p class="card-text text-muted mb-3">Download a JSON backup of your tracked data.</p>
                        <form id="export-form">
                            <div class="mb-3">
                                <label class="form-label">Data to Export</label>
                                <select class="form-select" name="data_type" id="export-type">
                                    <option value="all">Everything (Queries, Brands, MSRPs)</option>
                                    <option value="queries">Search Queries</option>
                                    <option value="brands">Brand Keywords</option>
                                    <option value="msrp">MSRP Entries</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Download JSON</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card h-100 border-warning">
                    <div class="card-body">
                        <h5 class="card-title text-warning">Import Data</h5>
                        <p class="card-text text-muted mb-3">Upload a JSON file to restore data.</p>
                        <form id="import-form">
                            <div class="mb-3">
                                <label class="form-label">JSON File</label>
                                <input class="form-control" type="file" id="import-file" accept=".json" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Data to Import</label>
                                <select class="form-select" name="data_type" id="import-type">
                                    <option value="all">Everything (Queries, Brands, MSRPs)</option>
                                    <option value="queries">Search Queries</option>
                                    <option value="brands">Brand Keywords</option>
                                    <option value="msrp">MSRP Entries</option>
                                </select>
                            </div>
                            <div class="mb-2 form-check">
                                <input type="checkbox" class="form-check-input" id="import-overwrite" name="overwrite">
                                <label class="form-check-label" for="import-overwrite">Overwrite existing MSRP values</label>
                            </div>
                            <div class="mb-3 form-check text-danger">
                                <input type="checkbox" class="form-check-input" id="import-clear" name="clear_existing">
                                <label class="form-check-label" for="import-clear">Clear all existing data of this type first</label>
                            </div>
                            <button type="submit" class="btn btn-warning" id="import-submit-btn">Upload & Import</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Helper
async function api(method, url, body) {
    const opts = {method, headers: {'Content-Type': 'application/json'}};
    if (body) opts.body = JSON.stringify(body);
    const r = await fetch(url, opts);
    const payload = await r.json().catch(() => ({}));
    if (!r.ok) {
        const message = payload.detail || payload.error || `Request failed (${r.status})`;
        throw new Error(message);
    }
    return payload;
}

// Scheduler
async function schedulerAction(action) {
    await api('POST', `/api/scheduler/${action}`);
    location.reload();
}

// Settings form
document.getElementById('settings-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const data = {};
    for (const [k, v] of fd.entries()) data[k] = parseFloat(v);
    await api('PUT', '/api/settings', data);
    document.getElementById('settings-saved').style.display = 'inline';
    setTimeout(() => document.getElementById('settings-saved').style.display = 'none', 2000);
});

document.getElementById('webhook-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const events = Array.from(document.querySelectorAll('.webhook-event:checked')).map((el) => el.value);
    const ratio = parseFloat(document.getElementById('webhook-deal-ratio').value);
    const minDrop = parseFloat(document.getElementById('webhook-deal-drop').value);
    const batchSize = parseInt(document.getElementById('webhook-deal-batch').value, 10);
    if (!Number.isFinite(ratio) || !Number.isFinite(minDrop) || !Number.isInteger(batchSize)) {
        await showAlertModal('Deal thresholds must be valid numbers.', 'Invalid Input');
        return;
    }
    const data = {
        webhook_enabled: document.getElementById('webhook-enabled').checked,
        webhook_url: document.getElementById('webhook-url').value.trim(),
        webhook_provider: document.getElementById('webhook-provider').value,
        webhook_events: events,
        webhook_deal_max_price_to_retail_ratio: ratio,
        webhook_deal_min_drop_pct: minDrop,
        webhook_deal_batch_size: batchSize,
    };
    await api('PUT', '/api/settings', data);
    document.getElementById('webhook-saved').style.display = 'inline';
    setTimeout(() => document.getElementById('webhook-saved').style.display = 'none', 2000);
});

document.getElementById('webhook-test-btn').addEventListener('click', async (e) => {
    const btn = e.currentTarget;
    const original = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Sending...';
    try {
        await api('POST', '/api/settings/webhook-test', {
            webhook_url: document.getElementById('webhook-url').value.trim(),
            webhook_provider: document.getElementById('webhook-provider').value,
        });
        await showAlertModal('Test webhook sent successfully.', 'Webhook Test');
    } catch (err) {
        await showAlertModal(`Webhook test failed: ${err.message}`, 'Webhook Test Failed');
    } finally {
        btn.disabled = false;
        btn.textContent = original;
    }
});

// Search Queries
document.querySelectorAll('.query-toggle').forEach(cb => {
    cb.addEventListener('change', async () => {
        await api('PUT', `/api/search-queries/${cb.dataset.id}`, {enabled: cb.checked});
    });
});

document.getElementById('add-query-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    await api('POST', '/api/search-queries', {label: fd.get('label'), url: fd.get('url')});
    location.reload();
});

async function deleteQuery(id, btn) {
    await api('DELETE', `/api/search-queries/${id}`);
    btn.closest('tr').remove();
}

async function scrapeQuery(id, btn) {
    const original = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Queued...';
    try {
        await api('POST', `/api/search-queries/${id}/scrape`);
        setTimeout(() => {
            btn.textContent = original;
            btn.disabled = false;
        }, 1000);
    } catch (e) {
        btn.textContent = original;
        btn.disabled = false;
        await showAlertModal('Failed to trigger query scrape.', 'Request Failed');
    }
}

// Brands
document.getElementById('add-brand-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    await api('POST', '/api/brands', {brand: fd.get('brand'), keyword: fd.get('keyword')});
    location.reload();
});

async function deleteBrand(id, btn) {
    await api('DELETE', `/api/brands/${id}`);
    btn.closest('tr').remove();
}

// MSRP
document.getElementById('add-msrp-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const data = {brand: fd.get('brand'), model: fd.get('model'), msrp_cad: parseFloat(fd.get('msrp_cad'))};
    const usd = fd.get('msrp_usd');
    if (usd) data.msrp_usd = parseFloat(usd);
    await api('POST', '/api/msrp', data);
    location.reload();
});

async function deleteMsrp(id, btn) {
    await api('DELETE', `/api/msrp/${id}`);
    btn.closest('tr').remove();
}

// Data Management
document.getElementById('export-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const dataType = document.getElementById('export-type').value;
    window.location.href = `/api/settings/export?data_type=${encodeURIComponent(dataType)}`;
});

document.getElementById('import-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const fileInput = document.getElementById('import-file');
    if (!fileInput.files.length) {
        await showAlertModal('Please select a JSON file to import.', 'Import Error');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('data_type', document.getElementById('import-type').value);
    formData.append('clear_existing', document.getElementById('import-clear').checked);
    formData.append('overwrite', document.getElementById('import-overwrite').checked);

    const btn = document.getElementById('import-submit-btn');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Importing...';

    try {
        const r = await fetch('/api/settings/import', {
            method: 'POST',
            body: formData
            // Do NOT set Content-Type header. The browser automatically sets it with the boundary for FormData
        });
        
        const payload = await r.json().catch(() => ({}));
        if (!r.ok) {
            throw new Error(payload.detail || payload.error || `Request failed (${r.status})`);
        }
        
        const res = payload.result;
        let msg = 'Data imported successfully!\n\n';
        if (res.queries > 0) msg += `• ${res.queries} Search Queries\n`;
        if (res.brands > 0) msg += `• ${res.brands} Brand Keywords\n`;
        if (res.msrp > 0) msg += `• ${res.msrp} MSRP Entries\n`;
        
        await showAlertModal(msg, 'Import Complete');
        location.reload();
    } catch (err) {
        await showAlertModal(`Failed to import data: ${err.message}`, 'Import Error');
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
        fileInput.value = '';
    }
});

async function clearDatabase() {
    const confirmed = await showConfirmModal({
        title: 'Clear Database',
        body: 'Clear all listing data from the database? This cannot be undone.',
        confirmText: 'Clear DB',
        confirmClass: 'btn-danger',
    });
    if (!confirmed) return;

    const result = await api('POST', '/api/settings/clear-db', {preserve_settings: true});
    if (result.ok) {
        await showAlertModal('Database cleared.', 'Success');
        window.location.href = '/';
    } else {
        await showAlertModal('Failed to clear database.', 'Request Failed');
    }
}
</script>
{% endblock %}
