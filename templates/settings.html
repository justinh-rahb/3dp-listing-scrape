{% extends "base.html" %}
{% block title %}Settings - 3DP Deal Tracker{% endblock %}

{% block content %}
<h4 class="mb-3">Settings</h4>

<!-- Scheduler Controls -->
<div class="card mb-4">
    <div class="card-body d-flex align-items-center justify-content-between">
        <div>
            <strong>Scheduler:</strong>
            <span id="sched-status" class="badge {% if scheduler.running %}bg-success{% else %}bg-secondary{% endif %}">
                {{ "Running" if scheduler.running else "Stopped" }}
            </span>
            {% if scheduler.running and scheduler.next_run %}
            <span class="text-muted ms-2">Next: {{ scheduler.next_run[:19] }}</span>
            {% endif %}
            <span id="sched-scraping" class="badge bg-warning ms-2" style="display:{% if scheduler.scraping %}inline{% else %}none{% endif %}">
                Scraping...
            </span>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-sm btn-success" onclick="schedulerAction('start')" id="btn-start"
                    {% if scheduler.running %}disabled{% endif %}>Start</button>
            <button class="btn btn-sm btn-danger" onclick="schedulerAction('stop')" id="btn-stop"
                    {% if not scheduler.running %}disabled{% endif %}>Stop</button>
            <button class="btn btn-sm btn-primary" onclick="schedulerAction('trigger')">Scrape Now</button>
        </div>
    </div>
</div>

<!-- Tabs -->
<ul class="nav nav-tabs" role="tablist">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-general">General</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-queries">Search Queries</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-brands">Brands</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-msrp">MSRP Data</a></li>
</ul>

<div class="tab-content pt-3">
    <!-- General Settings -->
    <div class="tab-pane active" id="tab-general">
        <form id="settings-form" class="row g-3" style="max-width: 500px;">
            <div class="col-12">
                <label class="form-label">Scrape interval (hours)</label>
                <input type="number" step="0.5" min="0.5" class="form-control" name="scrape_interval_hours"
                       value="{{ settings.scrape_interval_hours | default(6) }}">
            </div>
            <div class="col-12">
                <label class="form-label">Max pages per query</label>
                <input type="number" min="1" max="50" class="form-control" name="max_pages_per_query"
                       value="{{ settings.max_pages_per_query | default(5) }}">
            </div>
            <div class="col-6">
                <label class="form-label">Request delay min (sec)</label>
                <input type="number" step="0.5" min="0.5" class="form-control" name="request_delay_min"
                       value="{{ settings.request_delay_min | default(2) }}">
            </div>
            <div class="col-6">
                <label class="form-label">Request delay max (sec)</label>
                <input type="number" step="0.5" min="1" class="form-control" name="request_delay_max"
                       value="{{ settings.request_delay_max | default(5) }}">
            </div>
            <div class="col-12">
                <label class="form-label">Inactive threshold (missed runs)</label>
                <input type="number" min="1" max="20" class="form-control" name="inactive_threshold"
                       value="{{ settings.inactive_threshold | default(3) }}">
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-primary">Save Settings</button>
                <span id="settings-saved" class="text-success ms-2" style="display:none">Saved!</span>
            </div>
        </form>
    </div>

    <!-- Search Queries -->
    <div class="tab-pane" id="tab-queries">
        <table class="table table-sm" id="queries-table">
            <thead>
                <tr><th>Label</th><th>URL</th><th>Enabled</th><th></th></tr>
            </thead>
            <tbody>
                {% for q in queries %}
                <tr data-id="{{ q.id }}">
                    <td>{{ q.label }}</td>
                    <td class="text-truncate" style="max-width:400px">{{ q.url }}</td>
                    <td>
                        <input type="checkbox" class="form-check-input query-toggle"
                               data-id="{{ q.id }}" {% if q.enabled %}checked{% endif %}>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteQuery({{ q.id }}, this)">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <form id="add-query-form" class="row g-2 align-items-end" style="max-width: 700px;">
            <div class="col-3">
                <label class="form-label">Label</label>
                <input type="text" class="form-control form-control-sm" name="label" placeholder="e.g. bambu lab" required>
            </div>
            <div class="col-7">
                <label class="form-label">URL</label>
                <input type="url" class="form-control form-control-sm" name="url"
                       placeholder="https://www.kijiji.ca/b-canada/bambu-lab/k0l0" required>
            </div>
            <div class="col-2">
                <button type="submit" class="btn btn-sm btn-primary w-100">Add</button>
            </div>
        </form>
    </div>

    <!-- Brands -->
    <div class="tab-pane" id="tab-brands">
        <table class="table table-sm" id="brands-table">
            <thead>
                <tr><th>Brand</th><th>Keyword</th><th></th></tr>
            </thead>
            <tbody>
                {% for b in brands %}
                <tr data-id="{{ b.id }}">
                    <td>{{ b.brand }}</td>
                    <td>{{ b.keyword }}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteBrand({{ b.id }}, this)">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <form id="add-brand-form" class="row g-2 align-items-end" style="max-width: 500px;">
            <div class="col-4">
                <label class="form-label">Brand</label>
                <input type="text" class="form-control form-control-sm" name="brand" placeholder="e.g. bambu" required>
            </div>
            <div class="col-5">
                <label class="form-label">Keyword</label>
                <input type="text" class="form-control form-control-sm" name="keyword" placeholder="e.g. a1 combo" required>
            </div>
            <div class="col-3">
                <button type="submit" class="btn btn-sm btn-primary w-100">Add</button>
            </div>
        </form>
    </div>

    <!-- MSRP Data -->
    <div class="tab-pane" id="tab-msrp">
        <table class="table table-sm" id="msrp-table">
            <thead>
                <tr><th>Brand</th><th>Model</th><th>MSRP (CAD)</th><th>MSRP (USD)</th><th></th></tr>
            </thead>
            <tbody>
                {% for m in msrp %}
                <tr data-id="{{ m.id }}">
                    <td>{{ m.brand }}</td>
                    <td>{{ m.model }}</td>
                    <td>${{ "%.0f"|format(m.msrp_cad) }}</td>
                    <td>{% if m.msrp_usd %}${{ "%.0f"|format(m.msrp_usd) }}{% else %}-{% endif %}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteMsrp({{ m.id }}, this)">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <form id="add-msrp-form" class="row g-2 align-items-end" style="max-width: 700px;">
            <div class="col-3">
                <label class="form-label">Brand</label>
                <input type="text" class="form-control form-control-sm" name="brand" placeholder="bambu" required>
            </div>
            <div class="col-3">
                <label class="form-label">Model</label>
                <input type="text" class="form-control form-control-sm" name="model" placeholder="A1 Mini" required>
            </div>
            <div class="col-2">
                <label class="form-label">CAD $</label>
                <input type="number" class="form-control form-control-sm" name="msrp_cad" required>
            </div>
            <div class="col-2">
                <label class="form-label">USD $</label>
                <input type="number" class="form-control form-control-sm" name="msrp_usd">
            </div>
            <div class="col-2">
                <button type="submit" class="btn btn-sm btn-primary w-100">Add</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Helper
async function api(method, url, body) {
    const opts = {method, headers: {'Content-Type': 'application/json'}};
    if (body) opts.body = JSON.stringify(body);
    const r = await fetch(url, opts);
    return r.json();
}

// Scheduler
async function schedulerAction(action) {
    await api('POST', `/api/scheduler/${action}`);
    location.reload();
}

// Settings form
document.getElementById('settings-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const data = {};
    for (const [k, v] of fd.entries()) data[k] = parseFloat(v);
    await api('PUT', '/api/settings', data);
    document.getElementById('settings-saved').style.display = 'inline';
    setTimeout(() => document.getElementById('settings-saved').style.display = 'none', 2000);
});

// Search Queries
document.querySelectorAll('.query-toggle').forEach(cb => {
    cb.addEventListener('change', async () => {
        await api('PUT', `/api/search-queries/${cb.dataset.id}`, {enabled: cb.checked});
    });
});

document.getElementById('add-query-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    await api('POST', '/api/search-queries', {label: fd.get('label'), url: fd.get('url')});
    location.reload();
});

async function deleteQuery(id, btn) {
    await api('DELETE', `/api/search-queries/${id}`);
    btn.closest('tr').remove();
}

// Brands
document.getElementById('add-brand-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    await api('POST', '/api/brands', {brand: fd.get('brand'), keyword: fd.get('keyword')});
    location.reload();
});

async function deleteBrand(id, btn) {
    await api('DELETE', `/api/brands/${id}`);
    btn.closest('tr').remove();
}

// MSRP
document.getElementById('add-msrp-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const data = {brand: fd.get('brand'), model: fd.get('model'), msrp_cad: parseFloat(fd.get('msrp_cad'))};
    const usd = fd.get('msrp_usd');
    if (usd) data.msrp_usd = parseFloat(usd);
    await api('POST', '/api/msrp', data);
    location.reload();
});

async function deleteMsrp(id, btn) {
    await api('DELETE', `/api/msrp/${id}`);
    btn.closest('tr').remove();
}
</script>
{% endblock %}
