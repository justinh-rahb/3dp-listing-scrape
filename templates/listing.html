{% extends "base.html" %}
{% block title %}{{ listing.title }} - 3DP Deal Tracker{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Listings</a></li>
                <li class="breadcrumb-item active">{{ listing.title[:50] }}</li>
            </ol>
        </nav>

        <h4>{{ listing.title }}</h4>
        <div class="mb-2">
            <button type="button" onclick="toggleHide('{{ listing.kijiji_id }}', {{ 'false' if listing.is_hidden else 'true' }})"
                    class="btn btn-outline-secondary btn-sm"
                    data-kijiji-id="{{ listing.kijiji_id }}"
                    data-hidden="{{ 'true' if listing.is_hidden else 'false' }}">
                {{ 'Unhide listing' if listing.is_hidden else 'Hide listing' }}
            </button>
            <button type="button" onclick="deleteListingDetail('{{ listing.kijiji_id }}')"
                    class="btn btn-outline-danger btn-sm ms-1">
                Delete listing
            </button>
        </div>

        <div class="d-flex gap-3 mb-3">
            {% if listing.current_price is not none %}
            <h3 class="mb-0">{{ listing.currency or 'USD' }} ${{ "%.0f"|format(listing.current_price) }}</h3>
            {% else %}
            <h3 class="mb-0">Contact for price</h3>
            {% endif %}

            {% if listing.nominal_price and listing.current_price and listing.nominal_price != listing.current_price %}
                {% set drop = listing.nominal_price - listing.current_price %}
                {% if drop > 0 %}
                <span class="badge bg-success fs-6 align-self-center">
                    -{{ listing.currency or 'USD' }} ${{ "%.0f"|format(drop) }} ({{ "%.1f"|format(drop / listing.nominal_price * 100) }}% off)
                </span>
                {% endif %}
            {% endif %}

            <span id="msrp-badge"
                  class="badge bg-info fs-6 align-self-center {% if not listing.msrp %}d-none{% endif %}">
                {% if listing.msrp %}
                MSRP: ${{ "%.0f"|format(listing.msrp) }}
                ({{ "%.0f"|format(listing.current_price / listing.msrp * 100) }}%)
                {% endif %}
            </span>
        </div>

        <table class="table table-sm w-auto">
            <tr><td class="text-muted">Brand</td><td id="brand-value">{{ (listing.brand or 'Unknown')|title }}</td></tr>
            <tr><td class="text-muted">Model</td><td id="model-value">{{ listing.model or 'Unknown' }}</td></tr>
            <tr><td class="text-muted">Source</td><td>{{ (listing.source or 'kijiji')|upper }}</td></tr>
            <tr><td class="text-muted">Location</td><td>{{ listing.location or 'Unknown' }}</td></tr>
            <tr><td class="text-muted">First seen</td><td>{{ (listing.first_seen or '')[:10] }}</td></tr>
            <tr><td class="text-muted">Last seen</td><td>{{ (listing.last_seen or '')[:10] }}</td></tr>
            <tr><td class="text-muted">Original price</td><td>
                {% if listing.original_price is not none %}{{ listing.currency or 'USD' }} ${{ "%.0f"|format(listing.original_price) }}{% else %}N/A{% endif %}
            </td></tr>
            <tr><td class="text-muted">Nominal price</td><td>
                {% if listing.nominal_price is not none %}{{ listing.currency or 'USD' }} ${{ "%.0f"|format(listing.nominal_price) }}{% else %}N/A{% endif %}
            </td></tr>
            <tr><td class="text-muted">Status</td><td>
                {% if listing.is_active %}<span class="badge bg-success">Active</span>
                {% else %}<span class="badge bg-secondary">Inactive</span>{% endif %}
                {% if listing.is_hidden %}<span class="badge bg-dark">Hidden</span>{% endif %}
                {% if listing.on_sale %}<span class="badge bg-danger">Sale</span>{% endif %}
            </td></tr>
            <tr><td class="text-muted">Link</td><td><a href="{{ listing.url }}" target="_blank">View listing</a></td></tr>
        </table>

        <h6>Manual Brand/Model</h6>
        <form id="metadata-form" class="row g-2 mb-3" style="max-width: 540px;">
            <div class="col-md-5">
                <label for="brand-input" class="form-label text-muted mb-1">Brand</label>
                <input id="brand-input" class="form-control" type="text" value="{{ listing.brand or '' }}" placeholder="e.g. bambu">
            </div>
            <div class="col-md-5">
                <label for="model-input" class="form-label text-muted mb-1">Model</label>
                <input id="model-input" class="form-control" type="text" value="{{ listing.model or '' }}" placeholder="e.g. P1S">
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" id="metadata-save-btn" class="btn btn-primary w-100">Save</button>
            </div>
            <div class="col-12">
                <small id="metadata-saved-msg" class="text-success" style="display:none;">Saved.</small>
            </div>
        </form>

        {% if listing.description %}
        <h6>Description</h6>
        <div class="card card-body mb-3" style="max-height: 300px; overflow-y: auto;">
            {{ listing.description }}
        </div>
        {% endif %}

        <!-- Price History Chart -->
        <h6>Price History</h6>
        <div class="card card-body">
            {% if price_history|length > 1 %}
            <canvas id="priceChart" height="200"></canvas>
            {% else %}
            <p class="text-muted mb-0">Not enough data yet. Price history will appear after multiple scrape runs.</p>
            {% endif %}
        </div>
    </div>

    <!-- Images sidebar -->
    <div class="col-md-4">
        {% set images = listing.image_urls|from_json %}
        {% if images %}
        <div class="d-flex flex-column gap-2">
            {% for img_url in images %}
            <img src="{{ img_url }}" alt="Listing image" class="img-fluid rounded">
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const detailCurrentPrice = {{ "null" if listing.current_price is none else listing.current_price }};
const listingId = "{{ listing.kijiji_id }}";

function toTitleCaseWords(value) {
    return value.replace(/\w\S*/g, (word) => word.charAt(0).toUpperCase() + word.slice(1));
}

document.getElementById('metadata-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const saveBtn = document.getElementById('metadata-save-btn');
    const savedMsg = document.getElementById('metadata-saved-msg');
    const brandInput = document.getElementById('brand-input');
    const modelInput = document.getElementById('model-input');
    const brand = brandInput.value.trim();
    const model = modelInput.value.trim();

    saveBtn.disabled = true;
    saveBtn.textContent = 'Saving...';
    savedMsg.style.display = 'none';

    try {
        const response = await fetch(`/api/listing/${listingId}/metadata`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({brand, model}),
        });
        if (!response.ok) {
            throw new Error('Request failed');
        }
        const data = await response.json();
        const brandValue = document.getElementById('brand-value');
        const modelValue = document.getElementById('model-value');
        const msrpBadge = document.getElementById('msrp-badge');

        brandValue.textContent = data.brand ? toTitleCaseWords(data.brand) : 'Unknown';
        modelValue.textContent = data.model || 'Unknown';

        if (data.msrp && detailCurrentPrice !== null) {
            const msrpPct = Math.round((detailCurrentPrice / data.msrp) * 100);
            msrpBadge.textContent = `MSRP: $${Math.round(data.msrp)} (${msrpPct}%)`;
            msrpBadge.classList.remove('d-none');
        } else {
            msrpBadge.classList.add('d-none');
            msrpBadge.textContent = '';
        }

        savedMsg.style.display = 'inline';
        setTimeout(() => { savedMsg.style.display = 'none'; }, 2000);
    } catch (error) {
        console.error('Failed to save metadata', error);
        await showAlertModal('Failed to save brand/model. Please try again.', 'Save Failed');
    } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save';
    }
});

async function deleteListingDetail(kijiji_id) {
    const confirmed = await showConfirmModal({
        title: 'Delete Listing',
        body: 'Delete this listing? This cannot be undone.',
        confirmText: 'Delete',
        confirmClass: 'btn-danger',
    });
    if (!confirmed) return;
    const response = await fetch(`/api/listing/${kijiji_id}`, {method: 'DELETE'});
    if (!response.ok) {
        await showAlertModal('Failed to delete listing.', 'Delete Failed');
        return;
    }
    window.location.href = '/';
}
</script>
{% if price_history|length > 1 %}
<script>
fetch('/api/price-history/{{ listing.kijiji_id }}')
    .then(r => r.json())
    .then(data => {
        new Chart(document.getElementById('priceChart'), {
            type: 'line',
            data: {
                labels: data.dates,
                datasets: [{
                    label: 'Price ({{ listing.currency or "USD" }})',
                    data: data.prices,
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    fill: true,
                    tension: 0.1,
                    pointRadius: 4,
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: { callback: v => '{{ listing.currency or "USD" }} $' + v }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    });
</script>
{% endif %}
{% endblock %}
