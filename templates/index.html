{% extends "base.html" %}
{% block title %}Listings - 3DP Deal Tracker{% endblock %}

{% block content %}
<!-- Scheduler status bar -->
{% if scheduler %}
<div class="alert alert-sm py-1 px-3 mb-3 d-flex align-items-center gap-3
            {% if scheduler.running %}alert-success{% else %}alert-secondary{% endif %}" style="font-size: 0.85rem;">
    <span>
        Scheduler: <strong>{{ "Running" if scheduler.running else "Stopped" }}</strong>
    </span>
    {% if scheduler.running and scheduler.next_run %}
    <span>Next scrape: {{ scheduler.next_run[:19] }}</span>
    {% endif %}
    {% if scheduler.scraping %}
    <span class="badge bg-warning text-dark">Scraping now...</span>
    {% endif %}
    {% if scheduler.last_result %}
    <span class="text-muted">
        Last: {{ scheduler.last_result.found }} found, {{ scheduler.last_result.new }} new,
        {{ scheduler.last_result.price_changes }} price changes
    </span>
    {% endif %}
</div>
{% endif %}

<div class="row">
    <!-- Filters sidebar -->
    <div class="col-md-3 col-lg-2">
        <form method="get" class="mb-3">
            <h6>Filters</h6>

            <div class="mb-2">
                <input type="text" name="search" class="form-control form-control-sm"
                       placeholder="Search..." value="{{ filters.search or '' }}">
            </div>

            <div class="mb-2">
                <select name="brand" class="form-select form-select-sm">
                    <option value="">All Brands</option>
                    {% for brand in brands %}
                    <option value="{{ brand }}" {% if filters.brand == brand %}selected{% endif %}>
                        {{ brand|title }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-2">
                <input type="number" name="min_price" class="form-control form-control-sm"
                       placeholder="Min $" value="{{ filters.min_price or '' }}">
            </div>
            <div class="mb-2">
                <input type="number" name="max_price" class="form-control form-control-sm"
                       placeholder="Max $" value="{{ filters.max_price or '' }}">
            </div>

            <div class="mb-2">
                <input type="text" name="location" class="form-control form-control-sm"
                       placeholder="Location..." value="{{ filters.location or '' }}">
            </div>

            <div class="mb-2">
                <select name="sort_by" class="form-select form-select-sm">
                    <option value="last_seen_desc" {% if filters.sort_by == 'last_seen_desc' %}selected{% endif %}>Last Seen (Newest)</option>
                    <option value="last_seen_asc" {% if filters.sort_by == 'last_seen_asc' %}selected{% endif %}>Last Seen (Oldest)</option>
                    <option value="first_seen_desc" {% if filters.sort_by == 'first_seen_desc' %}selected{% endif %}>First Seen (Newest)</option>
                    <option value="first_seen_asc" {% if filters.sort_by == 'first_seen_asc' %}selected{% endif %}>First Seen (Oldest)</option>
                    <option value="price_asc" {% if filters.sort_by == 'price_asc' %}selected{% endif %}>Price: Low-High</option>
                    <option value="price_desc" {% if filters.sort_by == 'price_desc' %}selected{% endif %}>Price: High-Low</option>
                    <option value="price_drop_desc" {% if filters.sort_by == 'price_drop_desc' %}selected{% endif %}>Price Drop (High-Low)</option>
                    <option value="price_drop_asc" {% if filters.sort_by == 'price_drop_asc' %}selected{% endif %}>Price Drop (Low-High)</option>
                </select>
            </div>

            <div class="mb-2 form-check">
                <input type="hidden" name="active_only" value="0">
                <input type="checkbox" name="active_only" value="1" class="form-check-input" id="activeOnly"
                       {% if filters.active_only %}checked{% endif %}>
                <label class="form-check-label" for="activeOnly">Active only</label>
            </div>

            <div class="mb-2 form-check">
                <input type="hidden" name="show_hidden" value="0">
                <input type="checkbox" name="show_hidden" value="1" class="form-check-input" id="showHidden"
                       {% if filters.show_hidden %}checked{% endif %}>
                <label class="form-check-label" for="showHidden">Show hidden</label>
            </div>

            <button type="submit" class="btn btn-primary btn-sm w-100">Filter</button>
            <a href="/" class="btn btn-outline-secondary btn-sm w-100 mt-1">Reset</a>
        </form>

        {% if stats %}
        <div class="card card-body small">
            <strong>Stats</strong>
            <div>Active: {{ stats.active_listings }}</div>
            <div>Total: {{ stats.total_listings }}</div>
            <div>Snapshots: {{ stats.total_snapshots }}</div>
            <div>With drops: {{ stats.listings_with_drops }}</div>
            {% if stats.last_run %}
            <div class="mt-1 text-muted">Last scrape: {{ stats.last_run.started_at[:16] }}</div>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <!-- Listings table -->
    <div class="col-md-9 col-lg-10">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">{{ listings|length }} Listings</h5>
        </div>

        <div id="bulkActionsBar" class="alert alert-info py-2 px-3 mb-2" style="display: none;">
            <div class="d-flex align-items-center gap-3 flex-wrap">
                <span id="selectedCount">0 selected</span>
                <button class="btn btn-sm btn-primary" onclick="bulkHide()">
                    Hide Selected
                </button>
                <button class="btn btn-sm btn-outline-primary" onclick="bulkUnhide()">
                    Unhide Selected
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">
                    Clear Selection
                </button>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-sm table-hover">
                <thead>
                    <tr>
                        <th style="width: 40px;">
                            <input type="checkbox" id="selectAll" class="form-check-input" onchange="toggleSelectAll(this)">
                        </th>
                        <th></th>
                        <th><a href="{{ sort_urls.title }}" class="text-decoration-none link-body-emphasis">Title {{ sort_icons.title }}</a></th>
                        <th><a href="{{ sort_urls.price }}" class="text-decoration-none link-body-emphasis">Price {{ sort_icons.price }}</a></th>
                        <th><a href="{{ sort_urls.change }}" class="text-decoration-none link-body-emphasis">Change {{ sort_icons.change }}</a></th>
                        <th><a href="{{ sort_urls.brand }}" class="text-decoration-none link-body-emphasis">Brand {{ sort_icons.brand }}</a></th>
                        <th><a href="{{ sort_urls.location }}" class="text-decoration-none link-body-emphasis">Location {{ sort_icons.location }}</a></th>
                        <th><a href="{{ sort_urls.first_seen }}" class="text-decoration-none link-body-emphasis">First Seen {{ sort_icons.first_seen }}</a></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for listing in listings %}
                    <tr>
                        <td>
                            <input type="checkbox" class="form-check-input listing-checkbox"
                                   value="{{ listing.kijiji_id }}"
                                   data-hidden="{{ 'true' if listing.is_hidden else 'false' }}"
                                   onchange="updateBulkActions()">
                        </td>
                        <td>
                            {% set images = listing.image_urls|from_json %}
                            {% if images %}
                            <img src="{{ images[0] }}" alt="" class="listing-thumb">
                            {% endif %}
                        </td>
                        <td>
                            <a href="/listing/{{ listing.kijiji_id }}">{{ listing.title[:60] }}</a>
                            {% if not listing.is_active %}
                            <span class="badge bg-secondary">Inactive</span>
                            {% endif %}
                            {% if listing.is_hidden %}
                            <span class="badge bg-dark">Hidden</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if listing.current_price is not none %}
                            ${{ "%.0f"|format(listing.current_price) }}
                            {% else %}
                            Contact
                            {% endif %}
                        </td>
                        <td>
                            {% if listing.original_price and listing.current_price and listing.original_price != listing.current_price %}
                                {% set drop = listing.original_price - listing.current_price %}
                                {% if drop > 0 %}
                                <span class="text-success">-${{ "%.0f"|format(drop) }}</span>
                                {% else %}
                                <span class="text-danger">+${{ "%.0f"|format(-drop) }}</span>
                                {% endif %}
                            {% endif %}
                        </td>
                        <td>{{ (listing.brand or '')|title }}</td>
                        <td class="text-truncate" style="max-width: 150px;">{{ listing.location or '' }}</td>
                        <td>{{ (listing.first_seen or '')[:10] }}</td>
                        <td class="text-end">
                            <button onclick="toggleHide('{{ listing.kijiji_id }}', {{ 'false' if listing.is_hidden else 'true' }})"
                                    class="btn btn-outline-secondary btn-sm"
                                    data-kijiji-id="{{ listing.kijiji_id }}"
                                    data-hidden="{{ 'true' if listing.is_hidden else 'false' }}">
                                {{ 'Unhide' if listing.is_hidden else 'Hide' }}
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if not listings %}
        <div class="text-center text-muted py-5">
            No listings found. Run <code>python cli.py scrape</code> to fetch listings.
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Update listing count
function updateListingCount() {
    const count = document.querySelectorAll('tbody tr').length;
    const countElement = document.querySelector('h5.mb-0');
    if (countElement) {
        countElement.textContent = `${count} Listings`;
    }
}

// Track selected items
function updateBulkActions() {
    const checkboxes = document.querySelectorAll('.listing-checkbox:checked');
    const count = checkboxes.length;
    const bar = document.getElementById('bulkActionsBar');
    const countSpan = document.getElementById('selectedCount');

    if (count > 0) {
        bar.style.display = 'block';
        countSpan.textContent = `${count} selected`;
    } else {
        bar.style.display = 'none';
    }

    // Update "select all" checkbox state
    const selectAll = document.getElementById('selectAll');
    const allCheckboxes = document.querySelectorAll('.listing-checkbox');
    selectAll.checked = allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length;
    selectAll.indeterminate = count > 0 && count < allCheckboxes.length;
}

function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.listing-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
    });
    updateBulkActions();
}

function clearSelection() {
    document.querySelectorAll('.listing-checkbox').forEach(cb => {
        cb.checked = false;
    });
    document.getElementById('selectAll').checked = false;
    updateBulkActions();
}

async function bulkHide() {
    await performBulkAction(true);
}

async function bulkUnhide() {
    await performBulkAction(false);
}

async function performBulkAction(hide) {
    const checkboxes = document.querySelectorAll('.listing-checkbox:checked');
    const kijiji_ids = Array.from(checkboxes).map(cb => cb.value);

    if (kijiji_ids.length === 0) return;

    // Disable all controls
    const bar = document.getElementById('bulkActionsBar');
    const buttons = bar.querySelectorAll('button');
    buttons.forEach(btn => btn.disabled = true);

    try {
        const response = await fetch('/api/listings/bulk-hide', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({kijiji_ids, hide})
        });

        if (!response.ok) throw new Error('Bulk action failed');

        const data = await response.json();

        // Check if "show_hidden" filter is enabled
        const showHiddenCheckbox = document.getElementById('showHidden');
        const showHidden = showHiddenCheckbox && showHiddenCheckbox.checked;

        // Update UI for affected rows
        checkboxes.forEach(checkbox => {
            const row = checkbox.closest('tr');

            // If hiding items and show_hidden filter is off, remove the row
            if (data.is_hidden && !showHidden) {
                row.remove();
                return;
            }

            const titleCell = row.querySelector('td:nth-child(3)');
            const hiddenBadge = titleCell?.querySelector('.badge.bg-dark');
            const hideBtn = row.querySelector('[data-kijiji-id]');

            if (data.is_hidden && !hiddenBadge) {
                const badge = document.createElement('span');
                badge.className = 'badge bg-dark ms-1';
                badge.textContent = 'Hidden';
                titleCell.appendChild(badge);
            } else if (!data.is_hidden && hiddenBadge) {
                hiddenBadge.remove();
            }

            // Update hide button
            if (hideBtn) {
                hideBtn.textContent = data.is_hidden ? 'Unhide' : 'Hide';
                hideBtn.dataset.hidden = data.is_hidden;
                hideBtn.onclick = () => toggleHide(checkbox.value, !data.is_hidden);
            }

            checkbox.dataset.hidden = data.is_hidden;
        });

        clearSelection();
        updateListingCount();

        // Show success message
        const successMsg = document.createElement('div');
        successMsg.className = 'alert alert-success alert-dismissible fade show';
        successMsg.innerHTML = `
            <strong>Success!</strong> ${data.count} listing(s) ${hide ? 'hidden' : 'unhidden'}.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('main').prepend(successMsg);
        setTimeout(() => successMsg.remove(), 3000);

    } catch (error) {
        console.error('Bulk action error:', error);
        alert(`Failed to ${hide ? 'hide' : 'unhide'} listings. Please try again.`);
    } finally {
        buttons.forEach(btn => btn.disabled = false);
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', updateBulkActions);
</script>
{% endblock %}
